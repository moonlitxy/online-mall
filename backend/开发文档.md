# 在线商城后端开发文档

## 项目概述
基于Go 1.24.0 + Gin + MySQL + Redis技术栈开发的在线商城后端系统。

## 技术栈
- **后端框架**: Gin (v1.9.1)
- **数据库**: MySQL 8.0
- **缓存**: Redis 6.0
- **ORM**: GORM (v1.25.5)
- **JWT**: go-jwt (v4.4.3)
- **验证器**: validator (v10.14.0)
- **配置管理**: viper (v1.16.0)

## 目录结构
```
backend/
├── cmd/                    # 应用入口
│   └── server/            # 主程序
├── internal/              # 内部包
│   ├── api/               # API处理器
│   │   ├── controller/     # 控制器层
│   │   ├── middleware/    # 中间件
│   │   └── routes/        # 路由配置
│   ├── service/           # 业务逻辑层
│   ├── repository/        # 数据访问层
│   ├── models/           # 数据模型
│   ├── config/           # 配置管理
│   ├── utils/            # 工具函数
│   └── pkg/              # 内部包
├── configs/              # 配置文件
│   ├── config.yaml
│   └── config.dev.yaml
├── docs/                 # 文档
├── scripts/              # 脚本
├── go.mod
├── go.sum
└── main.go
```

## 数据库设计

### 用户相关表
```sql
-- 用户表
CREATE TABLE `users` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` varchar(50) NOT NULL COMMENT '用户名',
  `password` varchar(255) NOT NULL COMMENT '密码',
  `phone` varchar(20) DEFAULT NULL COMMENT '手机号',
  `email` varchar(100) DEFAULT NULL COMMENT '邮箱',
  `nickname` varchar(50) DEFAULT NULL COMMENT '昵称',
  `avatar` varchar(255) DEFAULT NULL COMMENT '头像',
  `status` tinyint(1) DEFAULT 1 COMMENT '状态：1-正常，0-禁用',
  `last_login_at` datetime DEFAULT NULL COMMENT '最后登录时间',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  UNIQUE KEY `uk_phone` (`phone`),
  UNIQUE KEY `uk_email` (`email`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';

-- 收货地址表
CREATE TABLE `addresses` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '地址ID',
  `user_id` bigint(20) NOT NULL COMMENT '用户ID',
  `name` varchar(50) NOT NULL COMMENT '收货人姓名',
  `phone` varchar(20) NOT NULL COMMENT '手机号',
  `province` varchar(50) NOT NULL COMMENT '省份',
  `city` varchar(50) NOT NULL COMMENT '城市',
  `district` varchar(50) NOT NULL COMMENT '区县',
  `detail` varchar(255) NOT NULL COMMENT '详细地址',
  `postcode` varchar(10) DEFAULT NULL COMMENT '邮编',
  `tag` varchar(20) DEFAULT NULL COMMENT '地址标签',
  `is_default` tinyint(1) DEFAULT 0 COMMENT '是否默认地址',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='收货地址表';
```

### 商品相关表
```sql
-- 商品分类表
CREATE TABLE `categories` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '分类ID',
  `name` varchar(50) NOT NULL COMMENT '分类名称',
  `parent_id` bigint(20) DEFAULT 0 COMMENT '父分类ID',
  `level` tinyint(1) DEFAULT 1 COMMENT '层级',
  `sort` int(11) DEFAULT 0 COMMENT '排序',
  `status` tinyint(1) DEFAULT 1 COMMENT '状态：1-显示，0-隐藏',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_parent_id` (`parent_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商品分类表';

-- 商品表
CREATE TABLE `products` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '商品ID',
  `name` varchar(255) NOT NULL COMMENT '商品名称',
  `category_id` bigint(20) NOT NULL COMMENT '分类ID',
  `description` text COMMENT '商品描述',
  `price` decimal(10,2) NOT NULL COMMENT '商品价格',
  `original_price` decimal(10,2) DEFAULT NULL COMMENT '原价',
  `stock` int(11) DEFAULT 0 COMMENT '库存',
  `sales` int(11) DEFAULT 0 COMMENT '销量',
  `images` json DEFAULT NULL COMMENT '商品图片',
  `video_url` varchar(255) DEFAULT NULL COMMENT '视频链接',
  `status` tinyint(1) DEFAULT 1 COMMENT '状态：1-上架，0-下架',
  `is_hot` tinyint(1) DEFAULT 0 COMMENT '是否热门',
  `is_new` tinyint(1) DEFAULT 0 COMMENT '是否新品',
  `sort` int(11) DEFAULT 0 COMMENT '排序',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_category_id` (`category_id`),
  KEY `idx_status` (`status`),
  KEY `idx_hot_new` (`is_hot`, `is_new`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商品表';

-- 商品SKU表
CREATE TABLE `product_skus` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'SKU ID',
  `product_id` bigint(20) NOT NULL COMMENT '商品ID',
  `name` varchar(255) NOT NULL COMMENT 'SKU名称',
  `specifications` json NOT NULL COMMENT '规格信息',
  `price` decimal(10,2) NOT NULL COMMENT 'SKU价格',
  `stock` int(11) DEFAULT 0 COMMENT 'SKU库存',
  `sales` int(11) DEFAULT 0 COMMENT 'SKU销量',
  `image` varchar(255) DEFAULT NULL COMMENT 'SKU图片',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_product_id` (`product_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商品SKU表';
```

### 订单相关表
```sql
-- 订单表
CREATE TABLE `orders` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '订单ID',
  `order_no` varchar(32) NOT NULL COMMENT '订单号',
  `user_id` bigint(20) NOT NULL COMMENT '用户ID',
  `address_id` bigint(20) NOT NULL COMMENT '地址ID',
  `total_amount` decimal(10,2) NOT NULL COMMENT '订单总金额',
  `freight` decimal(10,2) DEFAULT 0.00 COMMENT '运费',
  `discount_amount` decimal(10,2) DEFAULT 0.00 COMMENT '优惠金额',
  `pay_amount` decimal(10,2) NOT NULL COMMENT '支付金额',
  `pay_status` tinyint(1) DEFAULT 0 COMMENT '支付状态：0-未支付，1-已支付',
  `pay_time` datetime DEFAULT NULL COMMENT '支付时间',
  `payment_method` varchar(20) DEFAULT NULL COMMENT '支付方式',
  `order_status` tinyint(1) DEFAULT 0 COMMENT '订单状态：0-待付款，1-待发货，2-待收货，3-已完成，4-已取消',
  `cancel_reason` varchar(255) DEFAULT NULL COMMENT '取消原因',
  `cancel_time` datetime DEFAULT NULL COMMENT '取消时间',
  `remark` varchar(255) DEFAULT NULL COMMENT '订单备注',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_order_no` (`order_no`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_order_status` (`order_status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单表';

-- 订单商品表
CREATE TABLE `order_items` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '订单商品ID',
  `order_id` bigint(20) NOT NULL COMMENT '订单ID',
  `product_id` bigint(20) NOT NULL COMMENT '商品ID',
  `sku_id` bigint(20) NOT NULL COMMENT 'SKU ID',
  `product_name` varchar(255) NOT NULL COMMENT '商品名称',
  `product_image` varchar(255) DEFAULT NULL COMMENT '商品图片',
  `specifications` json DEFAULT NULL COMMENT '规格信息',
  `price` decimal(10,2) NOT NULL COMMENT '商品价格',
  `quantity` int(11) NOT NULL COMMENT '购买数量',
  `total_amount` decimal(10,2) NOT NULL COMMENT '小计金额',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_order_id` (`order_id`),
  KEY `idx_product_id` (`product_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单商品表';
```

### 其他表
```sql
-- 购物车表
CREATE TABLE `cart_items` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '购物车项ID',
  `user_id` bigint(20) NOT NULL COMMENT '用户ID',
  `product_id` bigint(20) NOT NULL COMMENT '商品ID',
  `sku_id` bigint(20) NOT NULL COMMENT 'SKU ID',
  `quantity` int(11) NOT NULL COMMENT '商品数量',
  `selected` tinyint(1) DEFAULT 1 COMMENT '是否选中',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_product_id` (`product_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='购物车表';

-- 优惠券表
CREATE TABLE `coupons` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '优惠券ID',
  `name` varchar(100) NOT NULL COMMENT '优惠券名称',
  `type` tinyint(1) NOT NULL COMMENT '类型：1-满减券，2-折扣券',
  `value` decimal(10,2) NOT NULL COMMENT '金额或折扣率',
  `min_amount` decimal(10,2) DEFAULT 0.00 COMMENT '最低使用金额',
  `start_time` datetime NOT NULL COMMENT '开始时间',
  `end_time` datetime NOT NULL COMMENT '结束时间',
  `stock` int(11) DEFAULT 0 COMMENT '库存',
  `used_count` int(11) DEFAULT 0 COMMENT '已使用数量',
  `status` tinyint(1) DEFAULT 1 COMMENT '状态：1-可用，0-停用',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='优惠券表';

-- 用户优惠券表
CREATE TABLE `user_coupons` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '用户优惠券ID',
  `user_id` bigint(20) NOT NULL COMMENT '用户ID',
  `coupon_id` bigint(20) NOT NULL COMMENT '优惠券ID',
  `order_id` bigint(20) DEFAULT NULL COMMENT '使用的订单ID',
  `status` tinyint(1) DEFAULT 0 COMMENT '状态：0-未使用，1-已使用，2-已过期',
  `used_time` datetime DEFAULT NULL COMMENT '使用时间',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_coupon` (`user_id`, `coupon_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_coupon_id` (`coupon_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户优惠券表';
```

## API接口设计

### 用户认证相关
```go
// 用户登录
POST /api/auth/login
Request: {
    "username": "string",
    "password": "string"
}

// 用户注册
POST /api/auth/register
Request: {
    "username": "string",
    "password": "string",
    "phone": "string",
    "email": "string",
    "nickname": "string"
}

// 用户信息
GET /api/auth/profile
```

### 用户管理相关
```go
// 获取用户列表
GET /api/users

// 获取用户详情
GET /api/users/:id

// 更新用户信息
PUT /api/users/:id

// 禁用/启用用户
PUT /api/users/:id/status
```

### 商品管理相关
```go
// 商品列表
GET /api/products
Query: {
    "page": 1,
    "size": 10,
    "category_id": 0,
    "keyword": "",
    "sort": "sales"
}

// 商品详情
GET /api/products/:id

// 添加商品
POST /api/products

// 更新商品
PUT /api/products/:id

// 删除商品
DELETE /api/products/:id

// 商品分类列表
GET /api/categories

// 添加分类
POST /api/categories

// 更新分类
PUT /api/categories/:id

// 删除分类
DELETE /api/categories/:id
```

### 购物车相关
```go
// 购物车列表
GET /api/cart

// 添加到购物车
POST /api/cart

// 更新购物车商品数量
PUT /api/cart/:id/quantity

// 删除购物车商品
DELETE /api/cart/:id

// 选择/取消选择商品
PUT /api/cart/:id/selected
```

### 订单相关
```go
// 创建订单
POST /api/orders

// 订单列表
GET /api/orders
Query: {
    "status": 0,
    "page": 1,
    "size": 10
}

// 订单详情
GET /api/orders/:id

// 取消订单
PUT /api/orders/:id/cancel

// 确认收货
PUT /api/orders/:id/receive

// 删除订单
DELETE /api/orders/:id
```

### 地址管理相关
```go
// 收货地址列表
GET /api/addresses

// 添加地址
POST /api/addresses

// 更新地址
PUT /api/addresses/:id

// 删除地址
DELETE /api/addresses/:id

// 设置默认地址
PUT /api/addresses/:id/default
```

### 优惠券相关
```go
// 优惠券列表
GET /api/coupons

// 领取优惠券
POST /api/coupons/:id/receive

// 我的优惠券
GET /api/coupons/my
Query: {
    "status": 0,
    "page": 1,
    "size": 10
}
```

## 中间件设计

### JWT认证中间件
```go
// 验证JWT Token
// 解析用户信息
// 权限检查
```

### 日志中间件
```go
// 请求日志记录
// 响应日志记录
// 错误日志记录
```

### 跨域中间件
```go
// CORS配置
// 允许的请求头
// 允许的请求方法
```

## 缓存设计

### Redis Key设计
```go
// 用户信息缓存
user:info:{user_id}

// 商品信息缓存
product:info:{product_id}

// 商品分类缓存
category:tree

// 购物车缓存
cart:{user_id}

// 用户优惠券缓存
user:coupons:{user_id}

// 热门商品缓存
hot:products

// 新品商品缓存
new:products
```

## 开发步骤

### 1. 环境准备
- 安装Go 1.24.0
- 安装MySQL 8.0
- 安装Redis 6.0
- 配置开发环境

### 2. 项目初始化
```bash
cd backend
go mod init online-mall
go get github.com/gin-gonic/gin
go get gorm.io/gorm
go get gorm.io/driver/mysql
go get github.com/golang-jwt/jwt/v5
go get github.com/go-redis/redis/v8
go get github.com/spf13/viper
go get github.com/go-playground/validator/v10
```

### 3. 基础框架搭建
- 配置文件设计
- 数据库连接
- Redis连接
- 路由配置
- 中间件配置

### 4. 模型开发
- 数据库模型定义
- 数据验证
- 关联关系处理

### 5. API开发
- 控制器开发
- 服务层开发
- 数据访问层开发

### 6. 功能实现
- 用户管理模块
- 商品管理模块
- 购物车模块
- 订单模块
- 优惠券模块

### 7. 测试
- 单元测试
- 接口测试
- 集成测试

### 8. 部署
- 配置文件优化
- 环境变量配置
- 部署脚本编写